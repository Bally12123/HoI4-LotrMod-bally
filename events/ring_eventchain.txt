###########################
# Ring Eventchain
###########################

add_namespace = fs



# Move into next state
country_event = {
	id = fs.1000

	is_triggered_only = yes
	hidden = yes

	immediate {
		# pop stack
		set_variable = { global.fs_currentstate = global.fs_path_stack^0 }
		add_to_variable = { global.fs_steps = 1 }
		remove_from_array = { array = global.fs_path_stack index = 0 }
		#log = "currentState: [?global.fs_currentstate]"

		# add to eventlog
		var:global.fs_currentstate = { ring_log_arrived_in_new_state = yes }


		# unique state-based encounters

		# Old forest encounter
		if = {
			limit = { check_variable = { global.fs_currentstate = 150 } }

			# Add Merry and Pippin
			FS_merry = { ring_add_member_to_fellowship_nolog = yes }
			FS_pippin = { ring_add_member_to_fellowship_nolog = yes }

			# eventlog
			add_to_array = { global.fs_eventlog_prefix_targets = 0 }
			add_to_array = { global.fs_eventlog_suffix_targets = 0 }
			add_to_array = { global.fs_eventlog = token:fs_event_merry_pippin_join }
			ring_trim_eventlog = yes

			# flavour
			if = {
				limit = { has_global_flag = fs_nazgul_sent_to_shire }
				add_to_array = { global.fs_eventlog_prefix_targets = 0 }
				add_to_array = { global.fs_eventlog_suffix_targets = 0 }
				add_to_array = { global.fs_eventlog = token:fs_event_old_forest_nazgul }
				ring_trim_eventlog = yes
			}
		}

		# Bree encounter
		else_if = {
			limit = { check_variable = { global.fs_currentstate = 149 } }

			# Add 'Strider'
			FS_aragorn = { ring_add_member_to_fellowship_nolog = yes }
			add_to_array = { global.fs_eventlog_prefix_targets = 0 }
			add_to_array = { global.fs_eventlog_suffix_targets = 0 }
			add_to_array = { global.fs_eventlog = token:fs_event_aragorn_in_bree }
			ring_trim_eventlog = yes

			# Gandalf not imprisoned -> he is in Bree
			if = {
				limit = { has_global_flag = gandalf_saruman_united }

				FS_gandalf = { ring_add_member_to_fellowship_nolog = yes }

				add_to_array = { global.fs_eventlog_prefix_targets = 0 }
				add_to_array = { global.fs_eventlog_suffix_targets = 0 }
				add_to_array = { global.fs_eventlog = token:fs_event_gandalf_in_bree }
				ring_trim_eventlog = yes
			}

			# Nazgul encounter
			if = {
				limit = { has_global_flag = fs_nazgul_sent_to_shire }

				add_to_array = { global.fs_eventlog_prefix_targets = 0 }
				add_to_array = { global.fs_eventlog_suffix_targets = 0 }
				add_to_array = { global.fs_eventlog = token:fs_event_bree_nazgul }
				ring_trim_eventlog = yes

				MOR = { country_event = { days = 5 id = mordor.54 } }
			}
		}

		# Weathertop encounter
		else_if = {
			limit = { check_variable = { global.fs_currentstate = 145 } }

			if = {
				limit = { has_global_flag = fs_nazgul_sent_to_shire }

				MOR = { country_event = { days = 7 id = mordor.55 } }
			}
			# No nazgul -> the whole group moves towards rivendell on foot
			else = {
				# Arwen joins because why not
				FS_arwen = { ring_add_member_to_fellowship = yes }
			}
		}

		# Bruinen Encounter
		else_if = {
			limit = { check_variable = { global.fs_currentstate = 200 } }

			# Nazgul (try to) catch up to Arwen on horseback
			if = {
				limit = { has_global_flag = fs_nazgul_sent_to_shire }

				random_list = {
					# Ring seized!
					2 = {
						MOR = { country_event = { days = 0 id = mordor.57 } }
					}
					# Nazgul couldnt catch up
					30 = {
						MOR = { country_event = { days = 0 id = mordor.58 } }
					}
					# Arwen summons flood-waters that sweep the Nazgul away
					68 = {
						# Eventlog
						add_to_array = { global.fs_eventlog_prefix_targets = 0 }
						add_to_array = { global.fs_eventlog_suffix_targets = 0 }
						add_to_array = { global.fs_eventlog = token:fs_event_bruinen_nazgul_wave }
						ring_trim_eventlog = yes

						# one of these nazgul die because of the water
						MOR = {
							random_list = {
								1 = { MOR_Akhorahil = { ring_combat_kill_character = yes } }
								1 = { MOR_Ji_Indur = { ring_combat_kill_character = yes } }
								1 = { MOR_Ren = { ring_combat_kill_character = yes } }
							}
							country_event = { days = 0 id = mordor.59 }
						}
					}
				}
			}
		}

		# Rivendell
		else_if = {
			limit = { check_variable = { global.fs_currentstate = 65 } }

			set_global_flag = fs_arrived_in_rivendell

			# Eventlog
			add_to_array = { global.fs_eventlog_prefix_targets = 0 }
			add_to_array = { global.fs_eventlog_suffix_targets = 0 }
			add_to_array = { global.fs_eventlog = token:fs_event_ring_arrives_in_rivendell }
			ring_trim_eventlog = yes

			# Gandalf arrives in Rivendell after escaping Saruman
			if = {
				limit = { has_global_flag = gandalf_imprisoned }
				add_to_array = { global.fs_eventlog_prefix_targets = 0 }
				add_to_array = { global.fs_eventlog_suffix_targets = 0 }
				add_to_array = { global.fs_eventlog = token:fs_event_gandalf_arrives_in_rivendell }
				ring_trim_eventlog = yes
			}

			# Chance of Bilbo giving frodo a sword and mithril armor
			random_list = {
				5 = {
					add_to_array = { global.fs_eventlog_prefix_targets = 0 }
					add_to_array = { global.fs_eventlog_suffix_targets = 0 }
					add_to_array = { global.fs_eventlog = token:fs_event_bilbo_gifts }
					ring_trim_eventlog = yes

					FS_frodo = {
						add_attack = 2
						add_defense = 2
					}
				}
				1 = {
					# no gifts lol
				}
			}

			ring_clear_fellowship_members = yes

			# Create base fellowship (This should heal the members up aswell)
			FS_frodo = { ring_add_member_to_fellowship = yes }
			FS_sam = { ring_add_member_to_fellowship = yes }
			FS_gandalf = { ring_add_member_to_fellowship = yes }

			# Hold Council of Elrond:
			add_to_array = { global.fs_eventlog_prefix_targets = 0 }
			add_to_array = { global.fs_eventlog_suffix_targets = 0 }
			add_to_array = { global.fs_eventlog = token:fs_event_rivendell_council_invoked }
			ring_trim_eventlog = yes
			RIV = { country_event = { days = 14 id = rivendell.1 } }
		}

		
		# Move into next state if fellowship still exists
		if = {
			limit = { NOT = { has_global_flag = fs_no_fellowship } }
			ring_fellowship_begin_move_to_next_state = yes
		}
	}
}



# Commence event-chain
country_event = {
	id = fs.1001

	is_triggered_only = yes
	hidden = yes

	immediate {
		SHI = {

			# set variables
			set_variable = { global.fs_currentstate = 42 }
			set_variable = { global.fs_steps = 1 }
			log = "currentState: [?global.fs_currentstate]"

			set_global_flag = fs_started

			# Initial fellowship
			FS_frodo = { ring_add_member_to_fellowship_nolog = yes }
			FS_sam = { ring_add_member_to_fellowship_nolog = yes }

			if = {
				limit = { has_global_flag = fs_nazgul_sent_to_shire }
				add_to_array = { global.fs_eventlog_prefix_targets = 0 }
				add_to_array = { global.fs_eventlog_suffix_targets = 0 }
				add_to_array = { global.fs_eventlog = token:fs_event_start }
				ring_trim_eventlog = yes
			}
			else = {
				add_to_array = { global.fs_eventlog_prefix_targets = 0 }
				add_to_array = { global.fs_eventlog_suffix_targets = 0 }
				add_to_array = { global.fs_eventlog = token:fs_event_start_nazgul }
				ring_trim_eventlog = yes
			}

			# Gandalf goes to meet Saruman
			ISE = { country_event = { days = 16 id = isengard.1 } }
			add_to_array = { global.fs_eventlog_prefix_targets = 0 }
			add_to_array = { global.fs_eventlog_suffix_targets = 0 }
			add_to_array = { global.fs_eventlog = token:fs_event_gandalf_goes_to_saruman }
			ring_trim_eventlog = yes

			# starting pathstack (Shire to Rivendell)
			add_to_array = { global.fs_path_stack = 150 }
			add_to_array = { global.fs_path_stack = 149 }
			add_to_array = { global.fs_path_stack = 145 }
			add_to_array = { global.fs_path_stack = 64 }
			add_to_array = { global.fs_path_stack = 200 }
			add_to_array = { global.fs_path_stack = 202 }
			add_to_array = { global.fs_path_stack = 65 }

			ring_fellowship_begin_move_to_next_state = yes

		}
	}
}


# Council of Elrond Concluded
country_event = {
	id = fs.1002

	is_triggered_only = yes
	hidden = yes

	immediate {
		# clear the temporary flags
		clr_global_flag = fs_mirkwood_responded
		clr_global_flag = fs_erebor_responded
		clr_global_flag = fs_gondor_responded

		# eventlog
		add_to_array = { global.fs_eventlog_prefix_targets = 0 }
		add_to_array = { global.fs_eventlog_suffix_targets = 0 }
		add_to_array = { global.fs_eventlog = token:fs_event_rivendell_council_concluded }
		ring_trim_eventlog = yes

		# newspaper event
		ring_execute_fellowship_newspaper_event = yes

		# Add Merry and Pippin
		FS_merry = { ring_add_member_to_fellowship_nolog = yes }
		FS_pippin = { ring_add_member_to_fellowship_nolog = yes }
		
	}
}

