

# Initialize the variables at game start
lthi_initialize_values = {
	set_variable = { lthi_base_nandor_influence = 100 }
	set_variable = { lthi_base_noldor_influence = 35 }
	set_variable = { lthi_base_sindar_influence = 30 }
	set_variable = { lthi_base_halfelves_influence = 5 }
	set_variable = { lthi_base_nonelves_influence = 0 }
	set_variable = { lthi_base_orcs_influence = 0 }

	force_update_dynamic_modifier = yes

	add_dynamic_modifier = {
		modifier = lothlorien_base_influences
	}
	add_dynamic_modifier = {
		modifier = lthi_influence_bonuses
	}

	# Bonus variables
	set_variable = { lthi_nandor_bonus_conscription = 0 }
	set_variable = { lthi_nandor_bonus_speed = 0 }
	set_variable = { lthi_nandor_bonus_organization = 0 }

	set_variable = { lthi_noldor_bonus_attack = 0 }
	set_variable = { lthi_noldor_bonus_breakthrough = 0 }
	set_variable = { lthi_noldor_bonus_factoryoutput = 0 }

	set_variable = { lthi_sindar_bonus_constructionspeed = 0 }
	set_variable = { lthi_sindar_bonus_supply = 0 }
	set_variable = { lthi_sindar_bonus_research = 0 }

	set_variable = { lthi_halfelves_bonus_experiencegain = 0 }
	set_variable = { lthi_halfelves_bonus_stability = 0 }
	set_variable = { lthi_halfelves_bonus_consumergoods = 0 }

	set_variable = { lthi_nonelves_bonus_monthlypop = 0 }
	set_variable = { lthi_orcs_bonus_strength = 0 }

	# max bonus vars
	set_variable = { lthi_nandor_bonus_conscription_base = 0.1 }
	set_variable = { lthi_nandor_bonus_speed_base = 0 }
	set_variable = { lthi_nandor_bonus_organization_base = 0 }

	set_variable = { lthi_noldor_bonus_attack_base = 0.1 }
	set_variable = { lthi_noldor_bonus_breakthrough_base = 0 }
	set_variable = { lthi_noldor_bonus_factoryoutput_base = 0 }

	set_variable = { lthi_sindar_bonus_constructionspeed_base = 0.1 }
	set_variable = { lthi_sindar_bonus_supply_base = 0 }
	set_variable = { lthi_sindar_bonus_research_base = 0 }

	set_variable = { lthi_halfelves_bonus_experiencegain_base = 0.1 }
	set_variable = { lthi_halfelves_bonus_stability_base = 0 }
	set_variable = { lthi_halfelves_bonus_consumergoods_base = 0 }

	set_variable = { lthi_nonelves_bonus_monthlypop_base = 0.1 }
	set_variable = { lthi_orcs_bonus_strength_base = 0.1 }

	lthi_update_values = yes
}


# Call this every time one of the influence vars is changed
lthi_update_values = {
	# Calculate sum
	set_variable = { lthi_influence_sum = modifier@nandor_influence }
	add_to_variable = { lthi_influence_sum = modifier@noldor_influence }
	add_to_variable = { lthi_influence_sum = modifier@sindar_influence }
	add_to_variable = { lthi_influence_sum = modifier@halfelves_influence }
	add_to_variable = { lthi_influence_sum = modifier@nonelves_influence }
	add_to_variable = { lthi_influence_sum = modifier@orcs_influence }

	# Calculate fractions
	set_variable = { lthi_nandor_influence_fraction = modifier@nandor_influence }
	set_variable = { lthi_noldor_influence_fraction = modifier@noldor_influence }
	set_variable = { lthi_sindar_influence_fraction = modifier@sindar_influence }
	set_variable = { lthi_halfelves_influence_fraction = modifier@halfelves_influence }
	set_variable = { lthi_nonelves_influence_fraction = modifier@nonelves_influence }
	set_variable = { lthi_orcs_influence_fraction = modifier@orcs_influence }
	divide_variable = { lthi_nandor_influence_fraction = lthi_influence_sum }
	divide_variable = { lthi_noldor_influence_fraction = lthi_influence_sum }
	divide_variable = { lthi_sindar_influence_fraction = lthi_influence_sum }
	divide_variable = { lthi_halfelves_influence_fraction = lthi_influence_sum }
	divide_variable = { lthi_nonelves_influence_fraction = lthi_influence_sum }
	divide_variable = { lthi_orcs_influence_fraction = lthi_influence_sum }

	# Ancestral Echoes in tandem focus: Noldor and Sindar share influence
	if = {
		limit = { has_completed_focus = lth_ancestralechoesintandem }
		
		add_to_variable = { lthi_noldor_influence_fraction = lthi_sindar_influence_fraction }
		add_to_variable = { lthi_sindar_influence_fraction = lthi_noldor_influence_fraction }
	}

	# Set bonus nandor
	set_variable = { lthi_nandor_bonus_conscription = lthi_nandor_bonus_conscription_base }
	set_variable = { lthi_nandor_bonus_speed = lthi_nandor_bonus_speed_base }
	set_variable = { lthi_nandor_bonus_organization = lthi_nandor_bonus_organization_base }
	multiply_variable = { lthi_nandor_bonus_conscription = lthi_nandor_influence_fraction }
	multiply_variable = { lthi_nandor_bonus_speed = lthi_nandor_influence_fraction }
	multiply_variable = { lthi_nandor_bonus_organization = lthi_nandor_influence_fraction }
		
	# Set bonus noldor
	set_variable = { lthi_noldor_bonus_attack = lthi_noldor_bonus_attack_base }
	set_variable = { lthi_noldor_bonus_breakthrough = lthi_noldor_bonus_breakthrough_base }
	set_variable = { lthi_noldor_bonus_factoryoutput = lthi_noldor_bonus_factoryoutput_base }
	multiply_variable = { lthi_noldor_bonus_attack = lthi_noldor_influence_fraction }
	multiply_variable = { lthi_noldor_bonus_breakthrough = lthi_noldor_influence_fraction }
	multiply_variable = { lthi_noldor_bonus_factoryoutput = lthi_noldor_influence_fraction }

	# Set bonus sindar
	set_variable = { lthi_sindar_bonus_constructionspeed = lthi_sindar_bonus_constructionspeed_base }
	set_variable = { lthi_sindar_bonus_supply = lthi_sindar_bonus_supply_base }
	set_variable = { lthi_sindar_bonus_research = lthi_sindar_bonus_research_base }
	multiply_variable = { lthi_sindar_bonus_constructionspeed = lthi_sindar_influence_fraction }
	multiply_variable = { lthi_sindar_bonus_supply = lthi_sindar_influence_fraction }
	multiply_variable = { lthi_sindar_bonus_research = lthi_sindar_influence_fraction }

	# Set bonus halfelves
	set_variable = { lthi_halfelves_bonus_experiencegain = lthi_halfelves_bonus_experiencegain_base }
	set_variable = { lthi_halfelves_bonus_stability = lthi_halfelves_bonus_stability_base }
	set_variable = { lthi_halfelves_bonus_consumergoods = lthi_halfelves_bonus_consumergoods_base }
	multiply_variable = { lthi_halfelves_bonus_experiencegain = lthi_halfelves_influence_fraction }
	multiply_variable = { lthi_halfelves_bonus_stability = lthi_halfelves_influence_fraction }
	multiply_variable = { lthi_halfelves_bonus_consumergoods = lthi_halfelves_influence_fraction }

	# Set bonus nonelves
	set_variable = { lthi_nonelves_bonus_monthlypop = lthi_nonelves_bonus_monthlypop_base }
	multiply_variable = { lthi_nonelves_bonus_monthlypop = lthi_nonelves_influence_fraction }

	# Set bonus orcs
	set_variable = { lthi_orcs_bonus_strength = lthi_orcs_bonus_strength_base }
	multiply_variable = { lthi_orcs_bonus_strength = lthi_orcs_influence_fraction }

	# If we have the unity_in_division modifer we need to find out how "evened out" the influence is
	# For this, we fing the highest and lowest values
	if = {
		limit = { has_dynamic_modifier = { modifier = lth_unity_in_division_modifier } }

		add_to_temp_array = { temp_infl = modifier@nandor_influence }
		add_to_temp_array = { temp_infl = modifier@noldor_influence }
		add_to_temp_array = { temp_infl = modifier@sindar_influence }
		add_to_temp_array = { temp_infl = modifier@halfelves_influence }
		if = {
			limit = { check_variable = { modifier@nonelves_influence > 0 } }
			add_to_temp_array = { temp_infl = modifier@nonelves_influence }
		}
		if = {
			limit = { check_variable = { modifier@orcs_influence > 0 } }
			add_to_temp_array = { temp_infl = modifier@orcs_influence }
		}

		find_highest_in_array = {
    		array = temp_infl
			value = temp_highest_influence
		}

		find_lowest_in_array = {
    		array = temp_infl
			value = temp_lowest_influence
		}

		# We subtract from 1 the difference between highest and lowest
		subtract_from_temp_variable = { temp_highest_influence = temp_lowest_influence }
		set_variable = { lth_influence_spread_bonus = 1 }
		subtract_from_variable = { lth_influence_spread_bonus = temp_highest_influence }

		# Multiply with base value (maximum bonus)
		multiply_variable = { lth_influence_spread_bonus = 0.15 }
	}
	# Purity and Brilliance: Any faction with more than 80% support automatically gets their bonus doubled
	else_if = {
		limit = { has_completed_focus = lth_purityandbrilliance }

		if = {
			limit = { check_variable = { lthi_noldor_influence_fraction > 0.8 } }
			multiply_variable = { lthi_noldor_bonus_attack = 2 }
			multiply_variable = { lthi_noldor_bonus_breakthrough = 2 }
			multiply_variable = { lthi_noldor_bonus_factoryoutput = 2 }
		}
		else_if = {
			limit = { check_variable = { lthi_nandor_influence_fraction > 0.8 } }
			multiply_variable = { lthi_nandor_bonus_conscription = 2 }
			multiply_variable = { lthi_nandor_bonus_speed = 2 }
			multiply_variable = { lthi_nandor_bonus_organization = 2 }
		}
		else_if = {
			limit = { check_variable = { lthi_sindar_influence_fraction > 0.8 } }
			multiply_variable = { lthi_sindar_bonus_constructionspeed = 2 }
			multiply_variable = { lthi_sindar_bonus_supply = 2 }
			multiply_variable = { lthi_sindar_bonus_research = 2 }
		}
		else_if = {
			limit = { check_variable = { lthi_halfelves_influence_fraction > 0.8 } }
			multiply_variable = { lthi_halfelves_bonus_experiencegain = 2 }
			multiply_variable = { lthi_halfelves_bonus_stability = 2 }
			multiply_variable = { lthi_halfelves_bonus_consumergoods = 2 }
		}
		else_if = {
			limit = { check_variable = { lthi_nonelves_influence_fraction > 0.8 } }
			multiply_variable = { lthi_nonelves_bonus_monthlypop = 2 }
		}
		else_if = {
			limit = { check_variable = { lthi_orcs_influence_fraction > 0.8 } }
			multiply_variable = { lthi_orcs_bonus_strength = 2 }
		}
	}
}

lthi_increase_influence_nandor_one = {
	add_to_variable = {
		var = lthi_base_nandor_influence
		value = 1
		tooltip = increase_influence_nandor_one_tt
	}
}

lthi_increase_influence_noldor_one = {
	add_to_variable = {
		var = lthi_base_noldor_influence
		value = 1
		tooltip = increase_influence_noldor_one_tt
	}
}

lthi_increase_influence_sindar_one = {
	add_to_variable = {
		var = lthi_base_sindar_influence
		value = 1
		tooltip = increase_influence_sindar_one_tt
	}
}

lthi_increase_influence_halfelves_one = {
	add_to_variable = {
		var = lthi_base_halfelves_influence
		value = 1
		tooltip = increase_influence_halfelves_one_tt
	}
}

lthi_increase_influence_orcs_one = {
	add_to_variable = {
		var = lthi_base_orcs_influence
		value = 1
		tooltip = increase_influence_orcs_one_tt
	}
}

lthi_increase_influence_nonelves_one = {
	add_to_variable = {
		var = lthi_base_nonelves_influence
		value = 1
		tooltip = increase_influence_nonelves_one_tt
	}
}

lthi_increase_influence_nandor_minor = {
	add_to_variable = {
		var = lthi_base_nandor_influence
		value = 10
		tooltip = increase_influence_nandor_minor_tt
	}
}

lthi_increase_influence_nandor_intermediate = {
	add_to_variable = {
		var = lthi_base_nandor_influence
		value = 25
		tooltip = increase_influence_nandor_intermediate_tt
	}
}

lthi_increase_influence_nandor_major = {
	add_to_variable = {
		var = lthi_base_nandor_influence
		value = 50
		tooltip = increase_influence_nandor_major_tt
	}
}

lthi_increase_influence_noldor_minor = {
	add_to_variable = {
		var = lthi_base_noldor_influence
		value = 10
		tooltip = increase_influence_noldor_minor_tt
	}
}

lthi_increase_influence_noldor_intermediate = {
	add_to_variable = {
		var = lthi_base_noldor_influence
		value = 25
		tooltip = increase_influence_noldor_intermediate_tt
	}
}

lthi_increase_influence_noldor_major = {
	add_to_variable = {
		var = lthi_base_noldor_influence
		value = 50
		tooltip = increase_influence_noldor_major_tt
	}
}

lthi_increase_influence_sindar_minor = {
	add_to_variable = {
		var = lthi_base_sindar_influence
		value = 10
		tooltip = increase_influence_sindar_minor_tt
	}
}

lthi_increase_influence_sindar_intermediate = {
	add_to_variable = {
		var = lthi_base_sindar_influence
		value = 25
		tooltip = increase_influence_sindar_intermediate_tt
	}
}

lthi_increase_influence_sindar_major = {
	add_to_variable = {
		var = lthi_base_sindar_influence
		value = 50
		tooltip = increase_influence_sindar_major_tt
	}
}

lthi_increase_influence_nonelves_minor = {
	add_to_variable = {
		var = lthi_base_nonelves_influence
		value = 10
		tooltip = increase_influence_nonelves_minor_tt
	}
}

lthi_increase_influence_nonelves_intermediate = {
	add_to_variable = {
		var = lthi_base_nonelves_influence
		value = 25
		tooltip = increase_influence_nonelves_intermediate_tt
	}
}

lthi_increase_influence_nonelves_major = {
	add_to_variable = {
		var = lthi_base_nonelves_influence
		value = 50
		tooltip = increase_influence_nonelves_major_tt
	}
}

lthi_increase_influence_orcs_minor = {
	add_to_variable = {
		var = lthi_base_orcs_influence
		value = 10
		tooltip = increase_influence_orcs_minor_tt
	}
}

lthi_increase_influence_orcs_intermediate = {
	add_to_variable = {
		var = lthi_base_orcs_influence
		value = 25
		tooltip = increase_influence_orcs_intermediate_tt
	}
}

lthi_increase_influence_orcs_major = {
	add_to_variable = {
		var = lthi_base_orcs_influence
		value = 50
		tooltip = increase_influence_orcs_major_tt
	}
}

lthi_increase_influence_orcs_huge = {
	add_to_variable = {
		var = lthi_base_orcs_influence
		value = 200
		tooltip = increase_influence_orcs_huge_tt
	}
}

lthi_increase_influence_halfelves_minor = {
	add_to_variable = {
		var = lthi_base_halfelves_influence
		value = 10
		tooltip = increase_influence_halfelves_minor_tt
	}
}

lthi_increase_influence_halfelves_intermediate = {
	add_to_variable = {
		var = lthi_base_halfelves_influence
		value = 25
		tooltip = increase_influence_halfelves_intermediate_tt
	}
}

lthi_increase_influence_halfelves_major = {
	add_to_variable = {
		var = lthi_base_halfelves_influence
		value = 50
		tooltip = increase_influence_halfelves_major_tt
	}
}

lthi_decrease_influence_nandor_minor = {
	add_to_variable = {
		var = lthi_base_nandor_influence
		value = -10
		tooltip = decrease_influence_nandor_minor_tt
	}
}

lthi_decrease_influence_nandor_intermediate = {
	add_to_variable = {
		var = lthi_base_nandor_influence
		value = -25
		tooltip = decrease_influence_nandor_intermediate_tt
	}
}

lthi_decrease_influence_nandor_major = {
	add_to_variable = {
		var = lthi_base_nandor_influence
		value = -50
		tooltip = decrease_influence_nandor_major_tt
	}
}

lthi_decrease_influence_noldor_minor = {
	add_to_variable = {
		var = lthi_base_noldor_influence
		value = -10
		tooltip = decrease_influence_noldor_minor_tt
	}
}

lthi_decrease_influence_noldor_intermediate = {
	add_to_variable = {
		var = lthi_base_noldor_influence
		value = -25
		tooltip = decrease_influence_noldor_intermediate_tt
	}
}

lthi_decrease_influence_noldor_major = {
	add_to_variable = {
		var = lthi_base_noldor_influence
		value = -50
		tooltip = decrease_influence_noldor_major_tt
	}
}

lthi_decrease_influence_sindar_minor = {
	add_to_variable = {
		var = lthi_base_sindar_influence
		value = -10
		tooltip = decrease_influence_sindar_minor_tt
	}
}

lthi_decrease_influence_sindar_intermediate = {
	add_to_variable = {
		var = lthi_base_sindar_influence
		value = -25
		tooltip = decrease_influence_sindar_intermediate_tt
	}
}

lthi_decrease_influence_sindar_major = {
	add_to_variable = {
		var = lthi_base_sindar_influence
		value = -50
		tooltip = decrease_influence_sindar_major_tt
	}
}

lthi_decrease_influence_halfelves_minor = {
	add_to_variable = {
		var = lthi_base_halfelves_influence
		value = -10
		tooltip = decrease_influence_halfelves_minor_tt
	}
}

lthi_decrease_influence_halfelves_intermediate = {
	add_to_variable = {
		var = lthi_base_halfelves_influence
		value = -25
		tooltip = decrease_influence_halfelves_intermediate_tt
	}
}

lthi_decrease_influence_halfelves_major = {
	add_to_variable = {
		var = lthi_base_halfelves_influence
		value = -50
		tooltip = decrease_influence_halfelves_major_tt
	}
}

lthi_decrease_influence_nonelves_minor = {
	add_to_variable = {
		var = lthi_base_nonelves_influence
		value = -10
		tooltip = decrease_influence_nonelves_minor_tt
	}
}

lthi_decrease_influence_nonelves_intermediate = {
	add_to_variable = {
		var = lthi_base_nonelves_influence
		value = -25
		tooltip = decrease_influence_nonelves_intermediate_tt
	}
}

lthi_decrease_influence_nonelves_major = {
	add_to_variable = {
		var = lthi_base_nonelves_influence
		value = -50
		tooltip = decrease_influence_nonelves_major_tt
	}
}

lthi_decrease_influence_orcs_minor = {
	add_to_variable = {
		var = lthi_base_orcs_influence
		value = -10
		tooltip = decrease_influence_orcs_minor_tt
	}
}

lthi_decrease_influence_orcs_intermediate = {
	add_to_variable = {
		var = lthi_base_orcs_influence
		value = -25
		tooltip = decrease_influence_orcs_intermediate_tt
	}
}

lthi_decrease_influence_orcs_major = {
	add_to_variable = {
		var = lthi_base_orcs_influence
		value = -50
		tooltip = decrease_influence_orcs_major_tt
	}
}



lthi_decrease_cw_timer = {
	# TODO
}

lthi_increase_cw_timer = {
	# TODO
}

lthi_increase_bonus_nandor = {
	custom_effect_tooltip = lthi_increase_bonus_nandor_tt
	multiply_variable = { lthi_nandor_bonus_conscription_base = 1.2 }
	multiply_variable = { lthi_nandor_bonus_organization_base = 1.2 }
	multiply_variable = { lthi_nandor_bonus_speed_base = 1.2 }
}

lthi_increase_bonus_noldor = {
	custom_effect_tooltip = lthi_increase_bonus_noldor_tt
	multiply_variable = { lthi_noldor_bonus_attack_base = 1.2 }
	multiply_variable = { lthi_noldor_bonus_breakthrough_base = 1.2 }
	multiply_variable = { lthi_noldor_bonus_factoryoutput_base = 1.2 }
}

lthi_increase_bonus_sindar = {
	custom_effect_tooltip = lthi_increase_bonus_sindar_tt
	multiply_variable = { lthi_sindar_bonus_constructionspeed_base = 1.2 }
	multiply_variable = { lthi_sindar_bonus_research_base = 1.2 }
	multiply_variable = { lthi_sindar_bonus_supply_base = 1.2 }
}

lthi_increase_bonus_halfelves = {
	custom_effect_tooltip = lthi_increase_bonus_halfelves_tt
	multiply_variable = { lthi_halfelves_bonus_consumergoods_base = 1.2 }
	multiply_variable = { lthi_halfelves_bonus_experiencegain_base = 1.2 }
	multiply_variable = { lthi_halfelves_bonus_stability_base = 1.2 }
}

lthi_decrease_bonus_nandor = {
	custom_effect_tooltip = lthi_decrease_bonus_nandor_tt
	multiply_variable = { lthi_nandor_bonus_conscription_base = 0.8 }
	multiply_variable = { lthi_nandor_bonus_organization_base = 0.8 }
	multiply_variable = { lthi_nandor_bonus_speed_base = 0.8 }
}

lthi_decrease_bonus_noldor = {
	custom_effect_tooltip = lthi_decrease_bonus_noldor_tt
	multiply_variable = { lthi_noldor_bonus_attack_base = 0.8 }
	multiply_variable = { lthi_noldor_bonus_breakthrough_base = 0.8 }
	multiply_variable = { lthi_noldor_bonus_factoryoutput_base = 0.8 }
}

lthi_decrease_bonus_sindar = {
	custom_effect_tooltip = lthi_decrease_bonus_sindar_tt
	multiply_variable = { lthi_sindar_bonus_constructionspeed_base = 0.8 }
	multiply_variable = { lthi_sindar_bonus_research_base = 0.8 }
	multiply_variable = { lthi_sindar_bonus_supply_base = 0.8 }
}

lthi_decrease_bonus_halfelves = {
	custom_effect_tooltip = lthi_decrease_bonus_halfelves_tt
	multiply_variable = { lthi_halfelves_bonus_consumergoods_base = 0.8 }
	multiply_variable = { lthi_halfelves_bonus_experiencegain_base = 0.8 }
	multiply_variable = { lthi_halfelves_bonus_stability_base = 0.8 }
}

lthi_decrease_bonus_nandor_major = {
	custom_effect_tooltip = lthi_decrease_bonus_nandor_major_tt
	multiply_variable = { lthi_nandor_bonus_conscription_base = 0.1 }
	multiply_variable = { lthi_nandor_bonus_organization_base = 0.1 }
	multiply_variable = { lthi_nandor_bonus_speed_base = 0.1 }
}

lthi_decrease_bonus_noldor_major = {
	custom_effect_tooltip = lthi_decrease_bonus_noldor_major_tt
	multiply_variable = { lthi_noldor_bonus_attack_base = 0.1 }
	multiply_variable = { lthi_noldor_bonus_breakthrough_base = 0.1 }
	multiply_variable = { lthi_noldor_bonus_factoryoutput_base = 0.1 }
}

lthi_decrease_bonus_sindar_major = {
	custom_effect_tooltip = lthi_decrease_bonus_sindar_major_tt
	multiply_variable = { lthi_sindar_bonus_constructionspeed_base = 0.1 }
	multiply_variable = { lthi_sindar_bonus_research_base = 0.1 }
	multiply_variable = { lthi_sindar_bonus_supply_base = 0.1 }
}

lthi_decrease_bonus_halfelves_major = {
	custom_effect_tooltip = lthi_decrease_bonus_halfelves_major_tt
	multiply_variable = { lthi_halfelves_bonus_consumergoods_base = 0.1 }
	multiply_variable = { lthi_halfelves_bonus_experiencegain_base = 0.1 }
	multiply_variable = { lthi_halfelves_bonus_stability_base = 0.1 }
}


lthi_send_to_valinor_nandor = {
	# TODO
}

lthi_send_to_valinor_noldor = {
	# TODO
}

lthi_send_to_valinor_sindar = {
	# TODO
}

lthi_send_to_valinor_halfelves = {
	# TODO
}


lth_on_weekly = {
	# New breed adds 3 orc influence every week
	if = {
		limit = { has_completed_focus = lth_anewbreed }
		add_to_variable = {
			var = lthi_base_orcs_influence
			value = 3
		}
	}

	lthi_update_values = yes
}

lth_spawn_spider_division = {
	load_oob = Lothlorien_Spiders
}

lth_spawn_spider_ent_division = {
	load_oob = Lothlorien_Spiders
}

lth_spawn_orc_penal_division = {
	if = {
		limit = { has_completed_focus = lth_thegiftofservitude }
		load_oob = Lothlorien_Orc_Prisoners_2
	}
	else = {
		load_oob = Lothlorien_Orc_Prisoners
	}
}


lth_on_yearly = {
	# clear flag whena t war with spoders
	if = {
		limit = {
			has_country_flag = lth_spider_cooperation
			any_country = {
				is_spiders = yes
				has_war_with = LTH
			}
		}
		clr_country_flag = lth_spider_cooperation
	}
	if = {
		limit = {
			has_country_flag = lth_spider_cooperation
			any_country = {
				is_ents = yes
				has_war_with = LTH
			}
		}
		clr_country_flag = lth_ent_cooperation
	}

	# Spawn spoder/ent divisions
	if = {
		limit = {
			has_completed_focus = lth_theforestbetween
			has_country_flag = lth_spider_cooperation
			has_country_flag = lth_ent_cooperation
			controls_state = 75
		}
		lth_spawn_spider_ent_division = yes
	}
	else_if = {
		limit = {
			has_country_flag = lth_spider_cooperation
			controls_state = 75
		}
		lth_spawn_spider_division = yes
	}
	if = {
		limit = {
			has_completed_focus = lth_sauronstoolsturned
			NOT = { is_ally_with = MOR }
			controls_state = 75
		}
		lth_spawn_orc_penal_division = yes
	}


	# immortal endurance growth
	if = {
		limit = {
			has_completed_focus = lth_endurethedarkness
			has_dynamic_modifier = { modifier = lth_immortal_endurance_modifier }
			check_variable = { lth_immortal_endurance_bonus < 0.5 } # cap
		}
		add_to_variable = { lth_immortal_endurance_bonus = 0.05 }
	}
	else_if = {
		limit = {
			has_dynamic_modifier = { modifier = lth_immortal_endurance_modifier }
			check_variable = { lth_immortal_endurance_bonus < 0.15 } # cap
		}

		add_to_variable = { lth_immortal_endurance_bonus = 0.03 }
	}

	if = {
		limit = {
			has_dynamic_modifier = { modifier = lth_immortal_endurance_modifier }
			has_completed_focus = lth_preservationofknowledge
		}
		set_variable = { lth_preservationofknowledge_bonus = var:lth_immortal_endurance_bonus }
	}
}

# Make the isoloationist_resevations idea less bad
lth_lower_isolationist_reservations = {
	if = {
		limit = { has_idea = LTH_isolationist_reservations_3 }
		swap_ideas = {
			remove_idea = LTH_isolationist_reservations_3
			add_idea = LTH_isolationist_reservations_2
		}
	}
	else_if = {
		limit = { has_idea = LTH_isolationist_reservations_2 }
		swap_ideas = {
			remove_idea = LTH_isolationist_reservations_2
			add_idea = LTH_isolationist_reservations_1
		}
	}
	else_if = {
		limit = { has_idea = LTH_isolationist_reservations_1 }
		remove_ideas = LTH_isolationist_reservations_1
	}
	else_if = {
		limit = { has_idea = LTH_isolationist_reservations_total_isolation }
		add_political_power = 100
	}
}

lthi_activate_nonelves = {
	custom_effect_tooltip = lthi_activate_nonelves_tt
	add_to_variable = { lthi_base_nonelves_influence = 50 }
}

lthi_activate_orcs = {
	custom_effect_tooltip = lthi_activate_orcs_tt
	add_to_variable = { lthi_base_orcs_influence = 50 }
}

lthi_hire_random_advisors = {
	# TODO: Fill treasurer, spymaster and political advisor slots with random advisors
}


lth_harmoinic_ascendandy_year_one = {
	add_political_power = 50
	random_state_add_building_slot_and_civ = yes
	random_state_add_building_slot_and_mil = yes
}

lth_harmoinic_ascendandy_year_two = {
	add_political_power = 100
	add_stability = 0.1
	add_war_support = 0.1
	random_state_add_building_slot_and_civ_x2 = yes
	random_state_add_building_slot_and_mil_x2 = yes
}

lth_harmoinic_ascendandy_year_three = {
	add_political_power = 150
	add_research_slot = 1
	random_state_add_building_slot_and_civ_x3 = yes
	random_state_add_building_slot_and_mil_x3 = yes
}

lth_accord_cele_term = {
	hidden_effect = {
		set_popularities = {
			belligerent = 50
			revolutionary = 50
		}
		set_politics = {
			ruling_party = revolutionary
			elections_allowed = no
		}

		add_timed_idea = {
			idea = LTH_celeborn_galadriel_accord_cele
			days = 365
		}

		# TODO: Gala becomes chief advisor that cant be fired
	}
	custom_effect_tooltip = lth_accord_cele_term_tt
}

lth_accord_gala_term = {
	hidden_effect = {
		set_popularities = {
			belligerent = 50
			revolutionary = 50
		}
		set_politics = {
			ruling_party = belligerent
			elections_allowed = no
		}

		add_timed_idea = {
			idea = LTH_celeborn_galadriel_accord_gala
			days = 365
		}

		# TODO: Cele becomes chief advisor that cant be fired
	}
	custom_effect_tooltip = lth_accord_gala_term_tt
}