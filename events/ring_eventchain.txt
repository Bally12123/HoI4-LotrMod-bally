###########################
# Ring Eventchain
###########################

add_namespace = fs



# Move into next state
country_event = {
	id = fs.1000

	is_triggered_only = yes
	hidden = yes

	immediate {
		# pop stack
		set_variable = { global.fs_currentstate = global.fs_path_stack^0 }
		add_to_variable = { global.fs_steps = 1 }
		remove_from_array = { array = global.fs_path_stack index = 0 }
		log = "currentState: [?global.fs_currentstate]"

		# add to event-log
		# TODO

		# no more entries on the patch-stack ---> Arrived at destination
		if = {
			limit = { check_variable = { global.fs_path_stack^num < 1 } }
			log = "RING DESTROYED"
		}

		# unique state-based encounters

		# Old forest encounter
		else_if = {
			limit = { check_variable = { global.fs_currentstate = 150 } }

			# Add Merry and Pippin
			FS_merry = { ring_add_member_to_fellowship = yes }
			FS_pippin = { ring_add_member_to_fellowship = yes }
		}

		# Bree encounter
		else_if = {
			limit = { check_variable = { global.fs_currentstate = 149 } }

			# Add 'Strider'
			FS_aragorn = { ring_add_member_to_fellowship = yes }
		}

		# Weathertop encounter
		else_if = {
			limit = { check_variable = { global.fs_currentstate = 145 } }

			# Only Frodo and Arwen
			ring_clear_fellowship_members = yes
			FS_frodo = { ring_add_member_to_fellowship = yes }
			FS_arwen = { ring_add_member_to_fellowship = yes }
		}

		# Buinen Encounter
		else_if = {
			limit = { check_variable = { global.fs_currentstate = 200 } }

			
		}

		# Rivendell
		else_if = {
			limit = { check_variable = { global.fs_currentstate = 65 } }

			log "RING AT RIVENDELL"

			set_global_flag = fs_no_fellowship
		}

		
		# Move into next state if fellowship still exists
		if = {
			limit = { NOT = { has_global_flag = fs_no_fellowship } }
			ring_move_into_next_state = yes
		}


	}
}



# Commence event-chain
country_event = {
	id = fs.1001

	is_triggered_only = yes
	hidden = yes

	immediate {
		# add to event-log
		# TODO

		# set variables
		set_variable = { global.fs_currentstate = 42 }
		set_variable = { global.fs_steps = 1 }
		log = "currentState: [?global.fs_currentstate]"

		# Initial fellowship
		FS_frodo = { ring_add_member_to_fellowship = yes }
		FS_sam = { ring_add_member_to_fellowship = yes }


		# TEMP: Testing out eventlog
		#add_to_array = { global.fs_eventlog = token:fs_event_frodo_depars_shire }
		#add_to_array = { global.fs_eventlog = token:fs_event_old_forest_encounter_avoided }
		#add_to_array = { global.fs_eventlog = token:fs_event_merry_and_pippin_join }

		# starting pathstack (Shire to Rivendell)
		add_to_array = { global.fs_path_stack = 150 }
		add_to_array = { global.fs_path_stack = 149 }
		add_to_array = { global.fs_path_stack = 145 }
		add_to_array = { global.fs_path_stack = 64 }
		add_to_array = { global.fs_path_stack = 200 }
		add_to_array = { global.fs_path_stack = 202 }
		add_to_array = { global.fs_path_stack = 65 }

		ring_move_into_next_state = yes
	}
}
